=====  Methodology  =====

Examine people, processes, & tech
> Do their security controls/tools work?
> Did they see us?
> Do their policies work?
> Does their training work?

External
	Phishing
	Network Scans
	Vulnerability Scans
	Web Apps
	OSINT
		breach databases
		DNS records
		WHOIS records
		File metadata
		Insecure cloud containers

Internal
	Network Scans
	Vulnerability Scans
	Web Apps
	Credential attacks
		Responder (only use -w as a last resort)
		Flamingo
		PCredz
		Default creds
		Anonymous logins
		Blank admin passwords

Closing the assessment
	rsync internal to external
	zip file share


=====  Team Share Folder Hierarchy  =====
* Deliverables generated by team
+ Documentation provided by customer

Archive
Data
	Database
		* AppDetectivePRO reports
	Network Mapping
		External
			Aquatone
				* copy of aquatone results
			Eyewitness
				* copy of eyewitness results
			Nmap
				Discovery
					* Parsed_Results and all 3 formats of output
				Full_Port
					* Parsed_Results and all 3 formats of output
			OSINT
		Internal
			Aquatone
				* copy of aquatone results
			Eyewitness
				* copy of eyewitness results
			Nmap
				Discovery
					* Parsed_Results and all 3 formats of output
				Full_Port
					* Parsed_Results and all 3 formats of output
	Penetration Test
		Cobalt Strike
			External
				* Activityreport.pdf
				* Hostsreport.pdf
				* Indicatorsofcompromise.pdf
				* Sessionsreport.pdf
				* TTP.pdf
			Internal
				* Activityreport.pdf
				* Hostsreport.pdf
				* Indicatorsofcompromise.pdf
				* Sessionsreport.pdf
				* TTP.pdf
	Phishing
		* External-Socialengineeringreport.pdf
		* Internal-Socialengineeringreport.pdf
		Payloads
		Targets
			+ Contacts.csv
			+ poc.txt
			* targets.txt
			* testing.txt
		Templates
			* Copy of first phishing email.eml
			* Copy of second phishing email.eml
	Vulnerability Scanning
		External
			Nessus
				* RVA-####.csv
				* RVA-####_ExecSummary.html
				* RVA-####.nessus
				* RVA-####_VulnsByHost.html
		Internal
			Nessus
				* RVA-####.csv
				* RVA-####_ExecSummary.html
				* RVA-####.nessus
				* RVA-####_VulnsByHost.html
	Web App
		External
			Nikto
				* RVA-####_nikto_results.html
			BurpSuite
				* RVA-####_burp_report.html
				* RVA-####_burp_report.xml
		Internal
			Nikto
				* nikto_results.html
			BurpSuite
				* RVA-####_burp_report.html
				* RVA-####_burp_report.xml
	Wireless
Documentation
	+ RVA Appendix A
	+ RVA Pre-assessment Questionnaire (PAQ)
Working
	CobaltStrike
		External
			* Activityreport.pdf
			* Hostsreport.pdf
			* Indicatorsofcompromise.pdf
			* Sessionsreport.pdf
			* Socialengineeringreport.pdf
			* TeamServer1.zip
			* TTP.pdf
		Internal
			* Activityreport.pdf
			* Hostsreport.pdf
			* Indicatorsofcompromise.pdf
			* Sessionsreport.pdf
			* Socialengineeringreport.pdf
			* TeamServer1.zip
			* TTP.pdf
	external
		* domain1_email_info.txt
		* domain2_email_info.txt
		* discovered_urls.txt
		* scope-ips.txt
		* scope-urls.txt
	internal
		* scope.txt
		* oos.txt
		* targets.txt


##########################
# Connect to SMB share on Team Share
##########################
mount -o username=asmtuser //172.20.10.99/share /mnt/share


##########################
# Team Share setup
##########################
# Copy folder-structure.sh script from Kali (tools/nlzr) to /home/asmtuser/
cd /root/tools/nlzr
chmod 755 folder-structure.sh
su asmtuser
./folder-structure.sh
# Select option 1

# Disable firewall
ufw disable


##########################
# PTP setup EXTERNAL
##########################
# Copy PTP image from Ripley
# Upload to Share server
mkdir ptportal
mv ptportal.zip ptportal/
cd ptportal
unzip ptportal.zip

# Install (instructions in README.md):
sudo apt-get update
sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
echo ‘deb [arch=amd64] https://download.docker.com/linux/debian buster stable’ | sudo tee /etc/apt/sources.list.d/docker.list
sudo apt-get update
sudo apt-get install docker-ce
docker --version

sudo curl -L "https://github.com/docker/compose/releases/download/1.25.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
docker-compose --version
	
sudo apt update
sudo apt install build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libsqlite3-dev libreadline-dev libffi-dev curl libbz2-dev
curl -O https://www.python.org/ftp/python/3.8.2/Python-3.8.2.tar.xz
tar -xf Python-3.8.2.tar.xz
cd Python-3.8.2
./configure --enable-optimizations
sudo make altinstall
python3 --version
	
chmod +x ptp.py
chmod +x docker/dev/wait-for-it.sh

# Start PTP
python3 ptp.py dev -r RVA
	## Check to see if PTP is live:
	### PTP will be hosted on port 443 if prod, 8080 if dev


##########################
# Network scanning
##########################
# Create in-scope and out-of-scope IP lists
	## Create in-scope by adding IP ranges in nmap format (ex: 10.0.0.0-10.1.2.255 192.168.1.0/24)
	## Create out-of scope IP list by adding testing infrastructure IPs in nmap format
		## List:
		Commando
		Kali1
		Kali2
		Kali3
		Share
		TeamServer
		WireGuard
		NUC
	## Combine lists with Scoper
/root/tools/scoper/Scoper.sh -i /root/Scans/scope.txt -e /root/Scans/oos.txt -o targets.txt
mv ./targets.txt /root/Scans/

# Disable firewall on scanning Kali
ufw disable

# Enable SSH (internal only)
service ssh start

# !! Make sure to run all scans from the Kali instance approved by Team Lead

# nmap discovery scans
	## Use the nmap discovery scan found here:
	## https://github.com/noahpowers/nlzr/blob/master/general_knowledge.txt
nmap -Pn -n -sS -p 21-23,25,53,111,137,139,445,80,443,8443,8080 --min-hostgroup 255 --min-rtt-timeout 0ms --max-rtt-timeout 100ms --max-retries 1 --max-scan-delay 0 --min-rate 2000 -oA CLIENT-# -vvv --open -iL <IPLIST>
	## Run gnmap-parser found here:
	## https://github.com/jasonjfrank/gnmap-parser
./Gnmap-Parser.sh

# Create list of live hosts for future scans 
sort /root/Scans/nmapdiscovery/Parsed-Results/Host-Lists/Alive-Hosts-Open-Ports.txt /root/Scans/nmapdiscovery/Parsed-Results/Host-Lists/Alive-Hosts-ICMP.txt | uniq > /root/Scans/targets-live.txt

# nmap full scan
	## Use the nmap full scan found here:
	## https://github.com/noahpowers/nlzr/blob/master/general_knowledge.txt
nmap -Pn -n -sS -p- -sV --min-hostgroup 255 --min-rtt-timeout 25ms --max-rtt-timeout 100ms --max-retries 1 --max-scan-delay 0 --min-rate 1000 -oA <customer-#> -vvv --open -iL <IPLIST>
	## Run gnmap-parser found here:
	## https://github.com/jasonjfrank/gnmap-parser
./Gnmap-Parser.sh

# Create a list of web targets
cp /root/Scans/nmapfull/Parsed-Results/Third-Party/PeepingTom.txt /root/Scans/web_targets.txt

# Launch aquatone scan
	## https://github.com/michenriksen/aquatone
cat /root/Scans/web_targets.txt | ./aquatone

# Launch eyewitness scan
	## https://github.com/FortyNorthSecurity/EyeWitness
python3 /root/tools/eyewitness/Python/EyeWitness.py --web -f /root/Scans/web_targets.txt -d /root/Scans/eyewitness --no-prompt

# Launch mikto OR nikto scan
	## Mikto: https://github.com/ChrisTruncer/mikto
/root/tools/mikto/Mikto.sh -f /root/Scans/web_targets.txt
	## Nikto: https://github.com/sullo/nikto
nikto -host /root/Scans/web_targets.txt -o /root/Scans/nikto/nikto_results.html -Format htm

# Run Nessus scans
service nessusd start
	## EXTERNAL: (run on dedicated Nessus VM) https://nessusip:8834
	## INTERNAL: (run on a team member's Kali VM) https://kali#:8834
	## Ask tech/team lead for license key and creds
	## Upgrade license to latest version of Nessus Professional to get plugin updates!
# Click "New Scan" button in top right corner
# Select Basic Network Scan
# Copy contents of /root/Scans/targets.txt into Targets section
# !! If scope is large, ask Team Lead about running against only the hosts found during the nmap discovery scan 
	## Report Export:
	## Make sure to run reports without any filters applied!
# Reports > html > Executive Summary
# 	- Rename RVA-####_ExecSummary
# Reports > html > Custom (leave all options default)
# 	- Rename RVA-####_VulnsByHost.html
# Reports > CSV > Generate Report
# Export > Nessus
	## !! DOUBLE CHECK TO MAKE SURE REPORTS INCLUDE ALL IN-SCOPE IPs


##########################
# Team Server setup EXTERNAL
##########################
# CobaltStrike and ServerSetup are located in the /root folder on TeamServer01 and TeamServer02
# !! run commands as root
# Update cobaltstrike:
bash /root/cobaltstrike_4.0/update

# Add values to setup script	
nano /root/ServerSetup/serversetup.sh
	## Update apikeyValue (Ask tech lead)
	## Update usernameValue (Ask tech lead)
	## Update updateIP to teamserver IP

# Run setup script
	## Run steps 1-4, 6, 7, 9 and 14
./serversetup.sh

# Debian Prep
Option 1
	## Enter your hostname (NOT FQDN):
mail
	## Enter your hostname[.]FQDN (without brackets):
hostname.domain.name (example: mail.assigneddomain.net)
	## Enter your External IP Address (or range):
<public IP address> (example: 69.45.24.12)
	## Are you using the NameCheap API for DNS? (y/N)
y
	## System will reboot

./serversetup.sh

# Account Setup
2
	## What account will emails come from?
username (example: ken.miller)
	## Document username/password in text file

	## Install SSL
3
	## Would you like to setup a wildcard SSL cert? (y/N)
N
	## Enter your server's domain or done to exit:
domain.name (FQDN example: assigneddomain.net)
done

# Install Mailserver
4
	## Hit "Ok" on Postfix Configuration
	## Internet Site
Enter domain.name (FQDN example: assigneddomain.net)
	## Hit "No" on Configuring opendmarc
	## Enter your mail server's domain (everything after the '@' sign):
domain.name (FQDN example: assigneddomain.net)
	## Enter IP's to allow Relay (if none just hit enter):
enter
	## !! You may need to hit "q" several times to close process information displays

# Get DNS Entries
7

# Install WebMail
14
	## Enter your mailing domain [ENTER]:
domain.name (FQDN example: assigneddomain.net)

# Check DKIM
9
	## !! Records may take a few minutes to propogate (3-5 min)
	## !! If you don't see this message, repeat step 7:
		[ + ] DKIM propagation was successful!
	## If the record doesn't propogate properly, run 15 then 7.
				
# Configure Rainloop (from web browser)
	## Visit domain.name:8443/?admin
	## Login with: admin:12345
	## Seurity: change password
	## Domains:
		## Click "Add Domain" button
			## Name: enter FQDN
			## IMAP server: enter FQDN
				## Secure: set to "SSL/TLS"
			## SMTP server: FQDN
				## Secure: set to "STARTTLS"
			## Check "Use short login" for both IMAP and SMTP
	## Login:
		## Make sure "Default Domain" is set to FQDN

# Test SMTP server
	## Visit domain.name:8443
		## Enter user credentials (from option 2)
			## Visit mail-tester.com, copy email address
			## Send sample email to mail-tester email
			## mail-tester score should be above a 7 (typically 8.6)
		## mailgenius.com/spam-test is another option (typically 87/100)

# Reconfigure firewall
ufw status numbered
	## Should display:
		[ 1]	Anywhere	ALLOW	<Host IP's subnet>
		[ 2]	Anywhere	ALLOW	<Host IP>
		[ 3]	80/tcp	ALLOW	Anywhere
		[ 4]	443/tcp	ALLOW	Anywhere
		[ 5]	587/tcp	ALLOW	Anywhere
		[ 6]	993/tcp	ALLOW	Anywhere
		[ 7]	25/tcp	ALLOW	Anywhere
		...
	## Block traffic to server when no testing or phishing operations are active
		## ufw insert 3 deny from any
	## Allow traffic to server for testing and phishing operations
		## ufw delete 3

# Set up Cobalt Strike Team Server
	## Configure CS jQuery profile
chmod 755 csjqueryprofile.sh
./csjqueryprofile.sh
	## Start teamserver
	## !! Always run in a tmux or screens sesssion so the CS server doesn't die with the SSH session
./teamserver <IP> <password> <profile> <killdate: YYYY-MM-DD>


TEST	> ALTERNATE: Configure Cobalt Strike Profile
TEST		> Amazon Mudge profile:
TEST			> ./serversetup.sh option 6
TEST			> python malleable-c2-randomizer.py -p /root/cobaltstrike_4.0/httpsProfile/amazon.profile -d /root/cobaltstrike_4.0/

# Log into teamserver
	## Configure https listener
https-listener, windows/beacon_https/reverse_https, <domain name>, 443, <domain name>
	## !! NEVER USE IP ADDRESSES ON EXTERNAL LISTENERS (always domain names)
	## SMB listeners (use mojo pipes found in jquery profile)
	## Load cna scripts into CS
		## https://github.com/harleyQu1nn/AggressorScripts
			## ProcessColor: colorizes ps command text to help identify useful processes
		## https://github.com/outflanknl/HelpColor
			# HelpColor: colorizes helpx commands to show what context they will run under
		## https://github.com/ajpc500/BOFs
			## curl
			## etw
			## functionutil
			## static_syscalls_apc_spawn
			## syscalls_dump
			## static_syscalls_inject
			## syscalls_inject
			# syscalls_spawn
		# https://github.com/trustedsec/CS-Situational-Awareness-BOF
			# Situational Awareness


##########################
# Phishing
##########################
## Create HTML template
## Compose new email in gmail
	## Reduce the width of the compose window as much as possible without squishing page content
## Send email to phishing email (on teamserver)
## Open Rainloop
	## View email
	## Click down arrow in upper right corner of email
		## Click "Download as .eml file"
	## Open .eml file
		## Ensure all links are set to "https://%url%"
	## Remove delivery data (everything from beginning to message to the line before "MIME-Version: 1.0")
	## Remove the entire line for:
		- Date:
		- To: 
		- Message-ID: 
	## Make sure the Subject: and From: lines are correct
	## Save template to share/Data/Phishing/Templates/phishtemplate.txt

# Set up Cobalt Strike phishing campaign
	## Attacks > Spear Phish
		## Target: create a text file with test email (phishmasterflex@gmail.com); set as target
		## Template: select phishtemplate.txt
		## Attachment: leave blank
		## Embed URL: host a sample text file and set it as the link location
		## Mail Server: 127.0.0.1,9 (local host, space emails 9 seconds apart)
		## Bounce To: set this as your phishing email account (first.last@phishing.com)
	## Preview
	## Send
	## Review: issues include broken links, poorly formatted images, random spaces inserted into words

# Test payloads & review phising email with customer
	## Create webpage with list of payloads to test
		## Make sure to not include CISA or any malware names (pezor, scarecrow, etc) in the name of payload files
		## Template: teamserver- /root/ServerSetup/testing-index.html
	## Make sure not to serve payloads with CISA or obfuscator names in the file name (ex: don't serve the payload as cisa-pezor.exe)
	## Make sure PoC is running under a non-admin context (low priv)
	## Ask PoC to reboot the payload testing machine after testing is concluded (wipe payloads from memory)
	## Review phishing template with customer
	## !! ** BEFORE STARTING CAMPAIGN: KILL ACTIVE BEACONS AND RESET THE DATA IN COBALT STRIKE UNDER REPORTING **
(reset data model)

# Launch phishing campaign
	## Repeat above steps replacing
	## Target: with customer provided email list
		## Randomize order of emails:
cat "targets.txt" | sort -u | shuf > randomized-targets.txt
			## Save a local copy (can take forever if running from team share)
	## Embed URL: with selected payload
	## Mail Server: 127.0.0.1,60 (local host, number of seconds to wait)
	## Bounce To: <email address set up for spamming>

# Monitor campaign:
	## If emails are not being delivered and mail-tester scores are above 8.9, sending IPs/domains may be banned
cat /var/log/mail.log | grep "banned"
	## If beacons become active: ASK TEAM LEAD BEFORE PERFORMING ANY ACTIONS

# Reporting
	## Save reports
		## External - DHS
			Share/Working/CobaltStrike/External/Activityreport.pdf
			Share/Working/CobaltStrike/External/Hostsreport.pdf
			Share/Working/CobaltStrike/External/Indicatorsofcompromise.pdf
			Share/Working/CobaltStrike/External/Sessionsreport.pdf
			Share/Working/CobaltStrike/External/Socialengineeringreport.pdf
			(Tactics, Techniques, and Procedures) – /Working/CobaltStrike/External/TTP.pdf
		## External - Customer (Check the "Mask email addresses and passwords" box for REDACTED reports)
			REDACTED: Share/Data/Penetration Test/Activityreport.pdf
			REDACTED: Share/Data/Penetration Test/Sessionsreport.pdf
			REDACTED: Share/Data/Phishing/Socialengineeringreport.pdf
			Share/Data/Penetration Test/Hostsreport.pdf
			Share/Data/Penetration Test/Indicatorsofcompromise.pdf
			(Tactics, Techniques, and Procedures) – Share/Data/Penetration Test/TTP.pdf

# Shut down team-servers
	## Connect to screens/tmux session or screen session
tmux a -t 0
screen -R
	## Issue abort command on Cobalt Strike pane
ctrl + c
exit
	## Back up and archive up teamserver
zip -r TeamServer1.zip cobaltstrike_4.0/
exit
scp root@<ip>:/root/TeamServer1.zip .
	## Make sure team share is mounted using
mount -o username=asmtuser //<Share Server IP>/share /mnt/share
mv Teamserver1.zip /mnt/share/Working/CobaltStrike/External/TeamServer1.zip
	## Repeat for teamserver 2 if second server was used
		## !! Create Teamserver2 subdirectories or prepend reports with "Teamserver#-"
	## Set UFW back to original state (block all traffic from outside server's subnet)
 ufw insert 3 deny from any
 ufw status


##########################
# App Detective Pro
##########################
* Make sure login domain is set to client's domain, not the IP/hostname
Export reports: Vulnerability Summary and Fix Scripts


##########################
# Assessment Wrap Up Tasks
##########################
# Sync internal Team Share to external Team Share
	## File flow: EXT <> NUC <> INT
	## Files must be rsynced to NUC before being moved to the INT/EXT Team Share
	## SYNTAX: rsync -azP <source> <destination>
# External to internal
	## log into external share, push to NUC
rsync -azP /share/ root@<IP>:/share/
	## log into internal share, pull from NUC
rsync -azP /share/ root@<IP>:/share/
# Internal to external
	## log into internal share, push to NUC
rsync -azP /share/ root@<IP>:/share/
	# log into external share, pull from NUC
rsync -azP root@<IP>:/share/ /share/


# Hash files for report:
cp /root/tools/nlzr/cya-hasher-noscreen.sh /mnt/Share/Working/
./cya-hasher-noscreen.sh /path/to/files/to/hash


##########################
# TROUBLESHOOTING
##########################
# Look for activity from NUC at customer site:
	## bounce-back.us servers are in the RAP section of VMWare Fusion NCATS server, username is root
	## Wireguard will attempt to call home on port TCP/51820
tail -f /var/log/ufw.log | grep 51820

	## The NUC can be accessed via web GUI
access phonetic.bounce-back.us/ui (phonetic = subdomain issued to RAP)